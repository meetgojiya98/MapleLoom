---
{
  "title": "Migrating from RefineDocumentsChain",
  "source_url": "https://python.langchain.com/docs/versions/migrating_chains/refine_docs_chain/",
  "fetched_at": "2025-08-15T13:52:02.690562+00:00"
}
---

# Migrating from RefineDocumentsChain

import
operator
from
typing
import
List
,
Literal
,
TypedDict
from
langchain_core
.
output_parsers
import
StrOutputParser
from
langchain_core
.
prompts
import
ChatPromptTemplate
from
langchain_core
.
runnables
import
RunnableConfig
from
langchain_openai
import
ChatOpenAI
from
langgraph
.
constants
import
Send
from
langgraph
.
graph
import
END
,
START
,
StateGraph
llm
=
ChatOpenAI
(
model
=
"gpt-4o-mini"
,
temperature
=
0
)
summarize_prompt
=
ChatPromptTemplate
(
[
(
"human"
,
"Write a concise summary of the following: {context}"
)
,
]
)
initial_summary_chain
=
summarize_prompt
|
llm
|
StrOutputParser
(
)
refine_template
=
"""
Produce a final summary.
Existing summary up to this point:
{existing_answer}
New context:
------------
{context}
------------
Given the new context, refine the original summary.
"""
refine_prompt
=
ChatPromptTemplate
(
[
(
"human"
,
refine_template
)
]
)
refine_summary_chain
=
refine_prompt
|
llm
|
StrOutputParser
(
)
class
State
(
TypedDict
)
:
contents
:
List
[
str
]
index
:
int
summary
:
str
async
def
generate_initial_summary
(
state
:
State
,
config
:
RunnableConfig
)
:
summary
=
await
initial_summary_chain
.
ainvoke
(
state
[
"contents"
]
[
0
]
,
config
,
)
return
{
"summary"
:
summary
,
"index"
:
1
}
async
def
refine_summary
(
state
:
State
,
config
:
RunnableConfig
)
:
content
=
state
[
"contents"
]
[
state
[
"index"
]
]
summary
=
await
refine_summary_chain
.
ainvoke
(
{
"existing_answer"
:
state
[
"summary"
]
,
"context"
:
content
}
,
config
,
)
return
{
"summary"
:
summary
,
"index"
:
state
[
"index"
]
+
1
}
def
should_refine
(
state
:
State
)
-
>
Literal
[
"refine_summary"
,
END
]
:
if
state
[
"index"
]
>=
len
(
state
[
"contents"
]
)
:
return
END
else
:
return
"refine_summary"
graph
=
StateGraph
(
State
)
graph
.
add_node
(
"generate_initial_summary"
,
generate_initial_summary
)
graph
.
add_node
(
"refine_summary"
,
refine_summary
)
graph
.
add_edge
(
START
,
"generate_initial_summary"
)
graph
.
add_conditional_edges
(
"generate_initial_summary"
,
should_refine
)
graph
.
add_conditional_edges
(
"refine_summary"
,
should_refine
)
app
=
graph
.
compile
(
)
